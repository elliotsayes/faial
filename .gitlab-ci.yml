---
image: registry.gitlab.com/umb-svl/faial/faial:ci
variables:

.cache: &global_cache
  before_script:
    - export PATH="$PATH:$CI_PROJECT_DIR"
    - export CARGO_HOME="$CI_PROJECT_DIR/cargo"
    - echo CARGO_HOME=$CARGO_HOME
    - rustup --version
    - rustc --version
    - cargo --version
    - opam --version
    - ocamlc --version
    - z3 --version
    - ls /opt/faial-ui
    - ls faial-ui/
    - cp -a /home/faial/.cargo "$CARGO_HOME"
    - echo "FOUND PACKAGES:"; find "$CARGO_HOME"/registry/ -iname '*.crate' -type f -exec basename '{}' \;
    - cp -a /opt/faial-ui/target "$CI_PROJECT_DIR/faial-ui/target"
    - ls faial-ui/

  cache:
    key: "Ubuntu-$CI_COMMIT_REF_NAME-1"
    paths:
    - .cargo
    - faial-ui/target
    - _build


test:
  <<: *global_cache
  script:
    - rm -f ./target/*/faial
    - cd "$CI_PROJECT_DIR"
    - eval $(opam config env)
    - cd faial-ui
    - cargo b
    - cp ./target/debug/faial ..
    - cd ..
    - export PATH="$PATH:$PWD"
    - make
    - make test
    - ./run-tests.py --verbose

build-dist:
  <<: *global_cache
  script:
    - cd "$CI_PROJECT_DIR"
    - rm -f ./target/*/faial
    - eval $(opam config env)
    - dune build --release
    - cp -Lr _build/install/default/bin/* ./
    - cd faial-ui
    - cargo b --release
    - cp ./target/release/faial ..

  artifacts:
    paths:
      - faial-bin
      - next-gen
      - faial
      - c-ast
      - pico
      - README.md
      - LICENSE

bundle:
  stage: deploy
  dependencies: 
    - build-dist
  only:
    # Only add branches that also exist in c-to-json and faial-infer!
    # Otherwise, this will fail as wget will not find their job artifacts.
    - master
    - cav21
  script:
    - cd $CI_PROJECT_DIR
    - mkdir bundle
    - cd bundle
    # c-to-json:
    - wget -nv --content-disposition https://gitlab.com/umb-svl/c-to-json/-/jobs/artifacts/$CI_COMMIT_BRANCH/raw/build/c-to-json-bin.tar.bz2?job=build
    - tar xf c-to-json-bin.tar.bz2
    - rm c-to-json-bin.tar.bz2
    # faial:
    - cp ../faial ../faial-bin ../pico ../c-ast ../next-gen bin/
    - cp ../README.md ../LICENSE  ./
    # display tree & bundle:
    - tree
    - tar jcvf faial.tar.bz2 *

  artifacts:
    paths:
      - bundle/faial.tar.bz2
