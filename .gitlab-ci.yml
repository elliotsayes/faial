---
image: registry.gitlab.com/umb-svl/faial/faial:dev
variables:
    PATH: "$PATH:$CI_PROJECT_DIR"
    CARGO_HOME: "$CI_PROJECT_DIR/cargo"

.tpl: &tpl
  before_script:
    - rustup --version
    - rustc --version
    - cargo --version
    - opam --version
    - ocamlc --version
    - cp -a /home/opam/.cargo "$CARGO_HOME"
    - cp /opt/faial-ui/target "$CI_PROJECT_DIR/faial-ui/target"

  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
    - .cargo
    - faial-ui/target
    - _build


test:
  <<: *tpl
  script:
    - cd "$CI_PROJECT_DIR"
    - eval $(opam config env)
    - cd faial-ui
    - cargo b --release
    - cd ..
    - make
    - make test
    - ./run-tests.py

build-dist:
  <<: *tpl
  script:
    - cd "$CI_PROJECT_DIR"
    - eval $(opam config env)
    - make
    - cd faial-ui
    - cargo b --release
    - cp ./target/release/faial ..

  artifacts:
    paths:
      - faial-bin
      - faial
      - README.md
      - LICENSE
