#|

Reduction #1: Slide 7

Source: https://developer.download.nvidia.com/assets/cuda/files/reduction.pdf

|#

shared g_idata, g_odata, sdata;

const
  local threadIdx.x,
  global blockDim.x,
  local blockIdx.x,
where
  threadIdx.x < blockDim.x &&
  distinct [blockIdx.x][threadIdx.x]
;

let i = blockIdx.x*blockDim.x+ threadIdx.x;

let tid = threadIdx.x;

ro g_idata[i];
rw sdata[blockIdx.x][tid];
sync;

foreach (s in 1.. blockDim.x && step * 2) {
    if (tid % (2 * s) == 0) {
        ro sdata[blockIdx.x][tid + s];
        rw sdata[blockIdx.x][tid];
    }
    sync;
}
if (tid == 0) {
  ro sdata[blockIdx.x][0];
  rw g_odata[blockIdx.x];
}
